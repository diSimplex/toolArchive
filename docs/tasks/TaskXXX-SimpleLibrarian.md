<header><title>Task 004 - Simple Librarian</title></header>

# Task 004 - Simple Librarian

1. Start implementation of the `librarian` message and http interfaces.

2. Start implementation of the `cnLibrarian` microservice.

3. Start implementation of the `cnClient` microservice.

4. A user should be able to publish the existence of a collection of 
artifacts using a `cnClient` microservice.

5. A user should be able to 'typeset' a given artifact using the 
`cnTypeSetter` microservice. 

## Architecture

- **`librarian`** (*interface*):

  - Provides an *eventually consistent* distributed database recording all 
  known artefact meta-data. Each microservice implementing the `librarian` 
  interface keeps its own view of the artifact meta-data in an SQLite3 on 
  disk database for later use/searching. 

  - Eventual consistency is maintained by each implementing microservice 
  listening to all `artifact.>` messages as generated by the 'standard' 
  requests needed to build artifacts. 

  - The 'penalty' of being only 'eventually consistent' is that sometimes:

    - The system will request an artifact from the wrong `librarian` 
    (Minor impact: the wrong `librarian` should redirect the system to the 
    correct `librarian`) 

    - The system will request an artifact from a non-existent `librarian` 
    (Major impact: the system will enter a missing dependency state) 

    - The system will request an artifact that no longer exists. (Major 
    impact: the system will enter a missing dependency state) 

    - The system may be missing a dependency (Major impact: the system 
    will enter a missing dependency state) 

    - The system may have an extra dependency which is no longer a 
    dependency. (Minor impact: the system may re-build something that does 
    not really need to be rebuilt) 

  - The artifact meta-data, WILL contain the 'holding' `librarian`. All 
  `librarians` consider the meta-data from the 'holding' `librarian` as 
  *definitive*. 

  - Provides a NATS message interface using the following subjects:
  
    - Listens for all `artifact.have.>` messages, recording where to 
    obtain a given artifact. 
    
    - Listens for all `artifact.wants.>` messagse, responding with any 
    corresponding meta-data that it holds. 

    - Listens for all `artifact.delete.>` messages, removing any 
    corresponding meta-data. 

  - Provides an http interface with the following routes:
  
    - An http route which clients can use to `GET` a given artifact. This 
    interface may respond with http code 303 'see other' to redirect a 
    client to another `cnLibrarian` in the federation. 

      This http route acts as a reverse proxy server to other cnNurser 
      microservices inside a given podman pod. 

    - An http route which a user can use, via a browser, to monitor what 
    is known about a given resource, 

  - Artifact meta-data consists of (at least) the following:

    - 'Holding' `librarian` (as a DNS name / IP address).

    - Last changed Timestamp (as a UNIX seconds from 1970 as a integer).

    - SHA256 file hash.

    - 'BuilderType' as NATS subject.

    - A list of dependent artifacts

- **`cnLibrarian`** (*microservice*): implements the above `librarian` 
interface. 

- **`cnClient`** (*microservice*):

  - implements (among other interfaces) the `librarian` interface. 

  - provides a tool for the user to inject `artifact.have` messages into 
  the cnNursery system, detailing where to find original source artifacts. 

  - provides a tool for the user to inject `artifact.want` messages into 
  the cnNursery system, detailing what needs to be built.

  - implements an http route which the user can use to list all files in a 
  given directory as `artifact.have`. 

  - implements an http route which the user can use to request a given 
  artifact to be built. 

## Reflections

### Ideas

- Is there a distinction between the 'request' (by an end user) using a 
http/RESTful interface and the 'messages' used by the underlying 
distributed system to communicate with itself? 

### Missing

- we are missing a way to create workspaces/projects (which contain 
collections of related artifact).

- we are missing a way to delete one or more artifacts.

- we are missing a way to delete a workspace/project.

## Resources

- [NATS documents](https://docs.nats.io/)

- [go.nats goDocs](https://godoc.org/github.com/nats-io/go-nats)
